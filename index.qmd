---
title: "dashboard_alpha"
format: dashboard
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: load-packages
#| message: false

library(tidyverse)
library(readxl)
library(scales)
library(DT)
library(gt)
library(glue)
# theme_set(theme_minimal(base_size = 24, base_family = "Atkinson Hyperlegible"))
```

```{r}
#| label: load-data
#| message: false

# seniority_in <- read_excel("data/2024-04 SeniorityList_UnionCopy.xlsx",
#                         sheet = "UNION_EXCEL_FILE",
#                         range = cell_cols("A:P")
#                         )


### Import and merge seniority lists ###

imported_seniority <- dir(path = "data/", 
                            full.names = T,
                            pattern = "\\d\\d\\d[34]-\\d\\d\\sSeniorityList_UnionCopy.xlsx"
)


### Create Function to build list of files ###

read_snrty_files <- function(file){
  if(is.na(file)) stop("no file path")
  imported_snrty <- read_excel(file,
                               sheet = "UNION_EXCEL_FILE",
                               range = cell_cols("A:P")
  )
  imported_snrty
}

### Bind files by folder ###

merged_seniority <- map_dfr(.x = imported_seniority, .f = read_snrty_files)


```

```{r}
#| label: prep-data

seniority <- merged_seniority %>% 
  rename_all(tolower) %>% 
  select(cmi, co_snrty = `company seniority`, snrty = `union seniority`, 4:7,
         equip_lock = `equip lock`, 9:12, tsp_elect = `tsp election`,
         year_month = `year month`, published) %>% 
  mutate(doh = ymd(doh), equip_lock = ymd(equip_lock), published = ymd(published),
         yos_r = ceiling( as.duration(doh %--% published) / dyears(1) )
         )

max_pub_floor <- floor_date(max(seniority$published), unit = "months")
pub_12m_lb <- add_with_rollback(max_pub_floor,
                  months(-12),
                  roll_to_first = F)

max_doh_floor <- floor_date(max(seniority$doh), unit = "months")
doh_12m_lb <- add_with_rollback(max_doh_floor,
                                months(-12),
                                roll_to_first = T)
```

```{r}
#| label: set-inputs

time_period_in <- paste(month(max_pub_floor, label = T),
                        year(max_pub_floor)
                        )
time_period <- time_period_in[1]
```

#  {.sidebar}

This dashboard displays statistics for:

|              |                     |
|--------------|---------------------|
| **Hospital** | Grey Sloan Memorial |
| **Unit**     | Labor and Delivery  |
| **Month**    | `{r} time_period`   |

------------------------------------------------------------------------

In `{r} time_period` the staff breakdown in the unit was as follows:

|                          |     |
|--------------------------|-----|
| **Attending physicians** |  14 |
| **Residents**            |  21 |
| **Nurses**               |  12 |

------------------------------------------------------------------------

::: {.callout-note collapse="true"}
## Disclaimer

This is a fictional hospital. The data are simulated based on realistic birth characteristics and risk factors from [this report by the CDC](https://www.cdc.gov/nchs/data/nvsr/nvsr72/nvsr72-01.pdf).
:::

# All

```{r}
#| label: all-values
#| results: hide

n_pilots <- seniority %>% 
  filter(published > max_pub_floor) %>% 
  nrow()

p_pic <- seniority %>% 
  filter(published > max_pub_floor) %>% 
  count(seat) %>% 
  mutate(p = n / sum(n)) %>% 
  filter(seat == "PIC") %>% 
  pull(p)

p_sic <- seniority %>% 
  filter(published > max_pub_floor) %>% 
  count(seat) %>% 
  mutate(p = n / sum(n)) %>% 
  filter(seat == "SIC") %>% 
  pull(p)

# n_births <- nrow(ld)
# 
# p_cesarean <- ld |>
#   count(delivery_method) |>
#   mutate(p = n / sum(n)) |>
#   filter(delivery_method == "Cesarean") |>
#   pull(p)
# 
# p_cesarean_color <- case_when(
#   between(p_cesarean, params$us_cesarean_rate, params$us_cesarean_rate + params$threshold_diff) ~ "warning",
#   p_cesarean > params$us_cesarean_rate + params$threshold_diff ~ "danger",
#   .default = "light"
#   )
# 
# p_preterm <- ld |>
#   count(term) |>
#   mutate(p = n / sum(n)) |>
#   filter(term == "Pre-term") |>
#   pull(p)
# 
# p_preterm_color <- case_when(
#   between(p_preterm, params$us_preterm_rate, params$us_preterm_rate + params$threshold_diff) ~ "warning",
#   p_preterm > params$us_preterm_rate + params$threshold_diff ~ "danger",
#   .default = "light"
#   )
```

## Row {height="20%"}

```{r}
#| content: valuebox
#| title: "Total Pilots"

list(
  icon = "globe",
  color = "primary",
  value = n_pilots
)
```

```{r}
#| content: valuebox
#| title: "Percent PIC"

list(
  icon = "person-lines-fill",
  color = "secondary",
  value = label_percent(accuracy = 0.1)(p_pic)
)
```

```{r}
#| content: valuebox
#| title: "Percent SIC"

list(
  icon = "person-lines-fill",
  color = "primary",
  value = label_percent(accuracy = 0.1)(p_sic)
)
```

## Row {height="80%}

### Column {Width="50%}

```{r}
#| title: "New Hires"

seniority %>% 
  select(cmi, doh, year_month, published) %>% 
  mutate(moh = str_pad(month(doh),2,pad = "0"),
         ymh = glue("{year(doh)}-{moh}"),
         ymh = as.character(ymh)) %>% 
  filter(doh > doh_12m_lb & published > max_pub_floor) %>% 
  select(cmi, ymh) %>% 
  count(ymh) %>% 
  ggplot(aes(x = ymh, y = n)) +
  geom_line(aes(group = "ymh"))+
  geom_point(size = 3)+
  geom_point(size = 6, shape = "circle open")+
  theme_bw()+
  labs(x = NULL,
       y = "Count")
```

### Column {Width="50%}

```{r}
#| title: "Total Pilots"

seniority %>% 
  select(cmi, doh, year_month, published) %>% 
  filter(published > pub_12m_lb) %>% 
  select(cmi, year_month) %>% 
  count(year_month) %>% 
  ggplot(aes(x = year_month, y = n)) +
  geom_line(aes(group = "year_month"))+
  geom_point(size = 3)+
  geom_point(size = 6, shape = "circle open")+
  theme_bw()+
  labs(x = NULL,
       y = "Count")
```